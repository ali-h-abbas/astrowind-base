---
import type { ImageMetadata } from 'astro';
import Layout from '~/layouts/PageLayout.astro';
import { sanityClient, urlFor } from '~/lib/sanity';
import { getPermalink } from '~/utils/permalinks';
import { findImage } from '~/utils/images';

export const prerender = true;

const metadata = {
  title: 'Blog',
  description: 'Explore articles, insights, and updates from our blog',
};

// Fetch all published posts from Sanity
const posts = await sanityClient.fetch(
  `*[_type == "post" && draft != true] | order(publishedAt desc) {
    _id,
    title,
    "slug": slug.current,
    excerpt,
    "author": author->{name, "slug": slug.current, image},
    "categories": categories[]->{ title, "slug": slug.current },
    tags,
    mainImage,
    publishedAt
  }`
);
---

<Layout metadata={metadata}>
  <section class="px-4 py-16 sm:px-6 mx-auto lg:px-8 lg:py-20 max-w-6xl">
    <header class="mb-8 md:mb-16 text-center">
      <h1 class="text-5xl md:text-6xl font-bold leading-tighter tracking-tighter mb-4 font-heading dark:text-gray-200">
        Blog
      </h1>
      <p class="text-xl text-muted dark:text-slate-400 max-w-3xl mx-auto">
        {metadata.description}
      </p>
    </header>

    {
      posts && posts.length > 0 ? (
        <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
          {posts.map((post: any) => (
            <article class="flex flex-col bg-white dark:bg-slate-900 rounded-lg shadow-lg overflow-hidden h-full">
              {post.mainImage && (
                <a href={getPermalink(`blog/${post.slug}`, 'post')} class="block relative h-64 overflow-hidden">
                  <img
                    src={urlFor(post.mainImage).width(600).height(400).url()}
                    alt={post.mainImage.alt || post.title}
                    class="w-full h-full object-cover hover:scale-110 transition duration-300"
                    loading="lazy"
                  />
                </a>
              )}
              
              <div class="flex flex-col flex-1 p-6">
                <header class="mb-4">
                  {post.categories && post.categories.length > 0 && (
                    <div class="mb-2">
                      {post.categories.map((category: any) => (
                        <span class="text-xs font-semibold text-primary uppercase tracking-wider">
                          {category.title}
                        </span>
                      ))}
                    </div>
                  )}
                  
                  <h2 class="text-xl font-bold leading-tight mb-2">
                    <a
                      href={getPermalink(`blog/${post.slug}`, 'post')}
                      class="hover:text-primary dark:hover:text-blue-400 transition ease-in duration-200"
                    >
                      {post.title}
                    </a>
                  </h2>
                </header>

                {post.excerpt && (
                  <p class="text-muted dark:text-slate-400 mb-4 flex-grow">
                    {post.excerpt}
                  </p>
                )}

                <footer class="flex items-center gap-3 mt-auto pt-4 border-t dark:border-slate-700">
                  {post.author?.image && (
                    <img
                      src={urlFor(post.author.image).width(40).height(40).url()}
                      alt={post.author.name}
                      class="rounded-full w-10 h-10"
                      loading="lazy"
                    />
                  )}
                  <div class="flex-1 min-w-0">
                    {post.author && (
                      <p class="text-sm font-medium dark:text-slate-300 truncate">
                        {post.author.name}
                      </p>
                    )}
                    <time
                      datetime={post.publishedAt}
                      class="text-xs text-muted dark:text-slate-400"
                    >
                      {new Date(post.publishedAt).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                      })}
                    </time>
                  </div>
                </footer>
              </div>
            </article>
          ))}
        </div>
      ) : (
        <div class="text-center py-12">
          <p class="text-xl text-muted dark:text-slate-400">
            No blog posts available yet. Check back soon!
          </p>
        </div>
      )
    }
  </section>
</Layout>
